name: üíø St2_Build-iStoreOS-ib
on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      openwrt_board:
        description: "ËØ∑ÈÄâÊã©ËÆæÂ§áÂûãÂè∑ÔºàÈªòËÆ§ÂΩìÂâçÂ∏∏ËßÅËÆæÂ§áÔºâ"
        required: true
        default: "a311d-oes_s905d_wxy-oect_jp-tvbox_s922x-oes-plus_fine3399_sv-33a6x_dg3399_dg-tn3568_smart-am40_smart-am60_sw799_king3399_panther-x2_firefly-rk3399_s905l3a"
        type: choice
        options:
          - a311d-oes_s905d_wxy-oect_jp-tvbox_s922x-oes-plus_fine3399_sv-33a6x_dg3399_dg-tn3568_smart-am40_smart-am60_sw799_king3399_panther-x2_firefly-rk3399_s905l3a
          - a311d
          - a311d-oes
          - alark35-3500
          - anas3035
          - aio-3399b
          - beikeyun
          - chainedbox
          - crrc
          - dc-a588
          - dg3399
          - dg-tn3568
          - dlfr100
          - e20c
          - e25
          - eaidk-610
          - emb3531
          - fine3399
          - firefly-rk3399
          - fmx1-pro
          - jp-tvbox
          - h28k
          - h66k
          - h68k
          - h69k
          - h88k
          - h88k-v3
          - h96-max-m2
          - hs530r
          - hugsun-x99
          - ipc-r
          - king3399
          - kylin3399
          - lckfb-tspi
          - leez
          - lx-r3s
          - mrkaio-m68s
          - nanopc-t6
          - nanopi-r5c
          - nanopi-r5s
          - orangepi-5-plus
          - orangepi-5b
          - panther-x2
          - photonicat
          - r66s
          - r68s
          - renegade-rk3328
          - rk3318-box
          - rock5b
          - rock5c
          - ruisen-box
          - s905
          - s905-beelink-mini
          - s905-mxqpro-plus
          - s905d
          - s905d-ki-pro
          - s905d-sml5442tw
          - s905l
          - s905l-aurora-1s
          - s905l-b860av21u
          - s905l-mg101
          - s905l2
          - s905l2-e900v21e
          - s905l2-wojia
          - s905l3
          - s905l3-cm211
          - s905l3-unt400g1
          - s905l3-unt402a
          - s905l3a
          - s905l3a-cm311
          - s905l3a-m401a
          - s905l3b
          - s905l3b-e900v21d
          - s905l3b-e900v22d
          - s905l3b-e900v22e
          - s905l3b-ip103h
          - s905l3b-rg020et-ca
          - s905l3b-unt403a
          - s905lb-ipbs9505
          - s905lb-q96-mini
          - s905lb-r3300l
          - s905mb
          - s905w
          - s905w-w95
          - s905w-x96-mini
          - s905w-x96w
          - s905x
          - s905x-b860h
          - s905x-nexbox-a95x
          - s905x-t95
          - s905x-tbee
          - s905x-tx9
          - s905x2
          - s905x2-km3
          - s905x2-x96max-2g
          - s905x2-hg680fj
          - s905x3
          - s905x3-2101
          - s905x3-a100
          - s905x3-a95xf3
          - s905x3-a95xf3-gb
          - s905x3-b
          - s905x3-h96max
          - s905x3-hk1
          - s905x3-ip1001m
          - s905x3-q1
          - s905x3-q2
          - s905x3-tx3
          - s905x3-tx3-bz
          - s905x3-ugoosx3
          - s905x3-whale
          - s905x3-x88-pro-x3
          - s905x3-x96air
          - s905x3-x96air-gb
          - s905x3-x96max
          - s912
          - s912-h96pro-plus
          - s912-m8s-pro
          - s912-nexbox-a1
          - s912-nexbox-a2
          - s912-onecloudpro
          - s912-phicomm-t1
          - s912-t95z-plus
          - s912-tx8-max
          - s912-tx9-pro-2g
          - s912-tx9-pro-3g
          - s912-x92
          - s912-zyxq-fake
          - s922x
          - s922x-ct2000
          - s922x-gtking
          - s922x-gtkingpro-h
          - s922x-odroid-n2
          - s922x-oes-plus
          - s922x-reva
          - s922x-ugoos-am6
          - seewo-sv21
          - smart-am40
          - smart-am60
          - station-m1
          - station-m2
          - sv-33a6x
          - swan1-w28
          - sw799
          - tanix-tx6
          - tb-ls3399
          - tn3399
          - tpm312
          - tqc-a01
          - tvi3315a
          - vplus
          - wocyber-a3
          - wxy-oect
          - wxy-oect-replaced
          - xiaobao
          - yskj
          - zcube1-max
          - zk-r39a
          - zysj
      openwrt_kernel:
        description: "ËØ∑ÈÄâÊã©ÂÜÖÊ†∏ÁâàÊú¨"
        required: true
        default: "6.1.y"
        type: choice
        options:
          - 5.15.196
          - 6.1.y
          - 6.6.y
          - 6.12.y
          - 6.6.115
          - 6.12.47
      auto_kernel:
        description: "Ëá™Âä®‰ΩøÁî®ÊúÄÊñ∞ÂÜÖÊ†∏"
        required: false
        default: true
        type: boolean
      openwrt_rootfs:
        description: "ËØ∑ÈÄâÊã©RootfsÈÄöÁî®Â∫ïÂåÖÔºàÂÖàÁ°Æ‰øùSt1ÊúâÁîüÊàêÔºâ"
        required: true
        default: "RELEASE"
        type: choice
        options:
          - RELEASE
      network_settings:
        description: "ËØ∑ÈÄâÊã©ÂàùÂßãÁΩëÁªúÈÖçÁΩÆÔºàÂÖàÁ°Æ‰øùSt1ÊúâÁîüÊàêÔºâ"
        required: true
        default: "dhcp"
        type: choice
        options:
          - static
          - dhcp

env:
  VERSION: 24.10.4

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: ‚è¨ ‰∏ãËΩΩ rootfs.tar.gz
        run: |
          echo "üì¶ Ê≠£Âú®‰∏ãËΩΩÈ¢ÑÊûÑÂª∫ rootfs"
          mkdir -p bin/targets/armsr/armv8
          curl -L -o bin/targets/armsr/armv8/openwrt-armvirt-64-default-rootfs.tar.gz \
            https://github.com/${{ github.actor }}/iStoreOS-Actions/releases/download/iStoreOS-${{ env.VERSION }}-${{ inputs.openwrt_rootfs }}-${{ inputs.network_settings }}/istoreos-armsr-armv8-generic-rootfs.tar.gz

      - name: üîç Êü•Êâærootfs.tar.gzÊâÄÂú®Ë∑ØÂæÑ
        id: find_rootfs
        run: |
          ROOTFS_FILE=$(find bin/targets/armsr/armv8/ -type f -name "*rootfs.tar.gz" | head -n1)
          echo "‚úÖ Found: $ROOTFS_FILE"
          if [ ! -f "$ROOTFS_FILE" ]; then
            echo "‚ùå Êâæ‰∏çÂà∞ rootfs.tar.gz Êñá‰ª∂"
            exit 1
          fi
          echo "file=$ROOTFS_FILE" >> $GITHUB_OUTPUT

      - name: üß± ÊâìÂåÖiStoreOSÂõ∫‰ª∂
        uses: ophub/amlogic-s9xxx-openwrt@main
        with:
          openwrt_path: ${{ steps.find_rootfs.outputs.file }}
          openwrt_board: ${{ inputs.openwrt_board }}
          openwrt_kernel: ${{ inputs.openwrt_kernel }}
          auto_kernel: ${{ inputs.auto_kernel }}
          kernel_repo: ophub/kernel
          kernel_usage: stable
          builder_name: kwonelee

      - name: üìú Ë∞ÉÊï¥.img.gz Êñá‰ª∂Âêç
        id: rename
        run: |
          for FILE in ${{ env.PACKAGED_OUTPUTPATH }}/*.img.gz; do
            echo "Processing file: $FILE"
            FILENAME=$(basename "$FILE")
            NEW_FILENAME=$(echo "$FILENAME" | sed 's/openwrt/istoreos_${{ env.VERSION }}/g')
            if [ "$FILENAME" != "$NEW_FILENAME" ]; then
              mv "$FILE" "${{ env.PACKAGED_OUTPUTPATH }}/$NEW_FILENAME"
              echo "Renamed $FILENAME to $NEW_FILENAME"
            else
              echo "No need to rename $FILENAME"
            fi
          done

      - name: üöÄ ‰∏ä‰º†Âà∞ Release
        uses: softprops/action-gh-release@v2.2.1
        with:
          tag_name: iStoreOS-${{ env.VERSION }}-${{ inputs.openwrt_rootfs }}-${{ inputs.network_settings }}
          files: |
            ${{ env.PACKAGED_OUTPUTPATH }}/*.img.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
